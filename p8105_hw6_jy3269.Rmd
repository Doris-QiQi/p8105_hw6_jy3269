---
title: "p8105_hw6_jy3269"
author: "Jingyi Yao"
date: "`r Sys.Date()`"
output: github_document
---

```{r,include=F}
library(tidyverse)
library(modelr)
```


## Problem 2

### 1. Create `city_state` variable and a binary `solved` variable 
```{r}
raw_data <- read_csv("./data/homicide-data.csv",show_col_types = FALSE)
homicide <- raw_data %>% 
  mutate(
    city_state = str_c(city,", ",state),
    solved = ifelse(disposition == "Closed by arrest",1,0)) %>% 
  mutate(
      victim_sex = fct_relevel(victim_sex, "Female"),
      victim_race = fct_relevel(victim_race, "White"),
         ) 

homicide

```

## 2. Omit cities : Dallas, TX; Phoenix, AZ; and Kansas City, MO  and  Tulsa, AL
```{r}
homicide <- homicide %>% 
  filter(city_state != "Dallas, TX", city_state != "Phoenix, AZ", city_state != "Kansas City, MO", city_state != "Tulsa, AL")

```


## 3. Limit your analysis those for whom victim_race is white or black
```{r}
homicide <- homicide %>% 
  filter(victim_race == "White" | victim_race == "Black") %>% 
  mutate(victim_age = as.numeric(victim_age))

```

## 4. Select the predictors and response variable in Baltimore
```{r}
baltimore_df = 
  homicide %>% 
  filter(city == "Baltimore") %>% 
  select(solved, victim_age, victim_race, victim_sex)

baltimore_df

```


## 5. Fit logistic regression for Baltimore
```{r}
Baltimore_logistic = 
  baltimore_df %>% 
  glm(solved ~ victim_age + victim_race + victim_sex, data = ., family = binomial())

```



## 6. Save the Baltimore model result as an R Object
```{r}
save(Baltimore_logistic, file = "./result/Baltimore_logistic.RData")

```



## 7. Tidy the object
```{r}
Baltimore_logistic %>% 
  broom::tidy() %>% 
  knitr::kable(digits = 3)


```


## 8. Get the 95% CI of OR and comparing male victims to female victims
```{r}
Baltimore_logistic %>% 
  broom::tidy() %>%
  mutate(OR = exp(estimate),
         OR_lower_bound = exp(confint(Baltimore_logistic)[,1]),
         OR_upper_bound = exp(confint(Baltimore_logistic)[,2])) %>%
  filter(term == 'victim_sexMale') %>% 
  select(estimate, OR,OR_lower_bound,OR_upper_bound) %>% 
  knitr::kable(digits = 3)


```


Therefore, in comparison to the baseline which is female, male has 0.425 times higher odds chance of getting a resolved case. Meaning that male has a lower chance to have a solved case than female.



```{r,message=FALSE, warning=FALSE}
cities_logistic = 
  homicide %>% 
  select(city_state, victim_race:victim_sex, solved) %>% 
  nest(sample = victim_race:solved) %>% 
  mutate(
    models = map(sample, ~glm(solved ~ victim_age+victim_race+victim_sex, family= binomial(), data=.x)),
    results = map(models, broom::tidy),
    conf_int = map(models, ~confint(.x,"victim_sexMale"))
  ) %>% 
  select(city_state,results,conf_int) %>% 
  unnest(results) %>% 
  unnest_wider(conf_int) %>% 
  filter(term == "victim_sexMale") %>% 
  select(city_state,estimate,`2.5 %`,`97.5 %`) %>% 
  mutate(
    OR = exp(estimate),
    OR_lower_bound = exp(`2.5 %`),
    OR_upper_bound = exp(`97.5 %`)
    ) %>% 
  select(city_state,estimate,OR,OR_lower_bound,OR_upper_bound) 
```


```{r}
cities_logistic %>% knitr::kable(digits = 3)

```


```{r}
ggplot(cities_logistic, aes(y = fct_reorder(city_state, OR), x = OR)) +
  geom_point() +
  geom_errorbar(aes(xmin = OR_lower_bound, xmax = OR_upper_bound)) +
  labs(title = "Estimated OR and 95% CI", ) + ylab("City,State") + theme(axis.text.y = element_text(hjust = 0.5,size = 6))

```



## Problem 3

```{r,message=FALSE}
data <- read_csv("./data/birthweight.csv")

data
```

### 1. Clean the data for regression analysis

```{r}
birthwt <- data %>% 
  mutate(
    frace = recode(frace, `1` = "White", `2` = "Black", `3` = "Asian", `4` = "Puerto Rican", `8` = "Other", `9` = "Unknown"),
    mrace = recode(mrace, `1` = "White", `2` = "Black", `3` = "Asian", `4` = "Puerto Rican", `8` = "Other"),
    babysex = recode(babysex, `1` = "Male", `2` = "Female")
    ) %>% 
    filter(frace != "Unknown") %>% 
  mutate(
    frace = fct_relevel(frace, "White"),
    mrace = fct_relevel(mrace, "White"),
    babysex = fct_relevel(babysex,"Female")
         ) %>% 
  select(bwt,everything())

birthwt


```


## 2. Fit a full model and using stepwise method to select variables
```{r}
# Fit the full model 
full_model <- lm(bwt ~., data = birthwt)

# begin stepwise procedure
stepwise_model <- MASS::stepAIC(full_model, direction = "backward", trace = FALSE)
summary(stepwise_model)


```


```{r}
birthwt %>%  
  add_predictions(stepwise_model) %>% 
  add_residuals(stepwise_model) %>% 
  ggplot(aes(x = pred, y = resid)) + geom_point() +
  labs(title = "Residuals against fitted values plot", ) + xlab("fitted value") + ylab("residuals")

```


```{r}
#first create a dataframe 
cv_df =
  crossv_mc(birthwt, 100) %>% 
  mutate(
    train = map(train, as_tibble),
    test = map(test, as_tibble))

#then fit three models:
cv_df = 
  cv_df %>% 
  mutate(
    my_model  = map(train, ~lm( bwt ~ babysex + bhead + blength + delwt + fincome + 
    gaweeks + mheight + mrace + parity + ppwt + smoken, data = .x)),
    main_effect_model  = map(train, ~lm(bwt ~ gaweeks + blength, data = .x)),
    interactive_model  = map(train, ~lm(bwt ~ bhead*blength*babysex, data = .x))) %>% 
  mutate(
    rmse_my_model = map2_dbl(my_model, test, ~rmse(model = .x, data = .y)),
    rmse_main_effect    = map2_dbl(main_effect_model, test, ~rmse(model = .x, data = .y)),
    rmse_interactive = map2_dbl(interactive_model, test, ~rmse(model = .x, data = .y)))

#Get the summarize the result:
cv_df %>% 
  summarize(
    rmse_my_model_mean = mean(rmse_my_model),
    rmse_main_effect_mean = mean(rmse_main_effect),
    rmse_interactive_meam = mean(rmse_interactive)
  ) %>% knitr::kable()


```


```{r}



```


```{r}



```


```{r}



```


```{r}



```










